name: build

on:
  push:
    branches-ignore:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: â¬‡ Checkout
        uses: actions/checkout@v6

      - name: âš™ï¸ Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm

      - name: âš™ï¸ Install dependencies
        run: npm ci

      - name: ðŸ§¹ Check code formatting
        run: npm run lint:check && npm run format:check && npm run svelte:check

      - name: ðŸ”¨ Build
        run: npm run build

      - name: ðŸ§ª Unit test
        run: npm run test

      - name: ðŸ“ Get Playwright version
        id: playwright-info
        run: |
          PLAYWRIGHT_VERSION=$(jq -r '.packages["node_modules/@playwright/test"].version' "./package-lock.json")

          if [[ -z "$PLAYWRIGHT_VERSION" ]]; then
            echo "Playwright version not found in package-lock.json in directory 'playwright'"
            exit 1
          fi

          echo "Playwright version: $PLAYWRIGHT_VERSION"
          echo "PLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "PLAYWRIGHT_BROWSER=chromium" >> $GITHUB_OUTPUT

      - name: ðŸ™ˆ Get caching Playwright
        id: restore-cache-playwright
        uses: actions/cache/restore@v5
        with:
          key: ${{ runner.os }}-playwright-${{ steps.playwright-info.outputs.PLAYWRIGHT_VERSION }}-${{ steps.playwright-info.outputs.PLAYWRIGHT_BROWSER }}
          path: |
            ~/.cache/ms-playwright

      - name: ðŸ§ª Install Playwright
        if: steps.restore-cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps --only-shell ${{ steps.playwright-info.outputs.PLAYWRIGHT_BROWSER }}

      - name: ðŸ§ª Integration test
        run: npm run test:playwright

      - name: ðŸ™ˆ Save caching Playwright
        id: save-cache-playwright
        if: always() && steps.restore-cache-playwright.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          key: ${{ runner.os }}-playwright-${{ steps.playwright-info.outputs.PLAYWRIGHT_VERSION }}-${{ steps.playwright-info.outputs.PLAYWRIGHT_BROWSER }}
          path: |
            ~/.cache/ms-playwright
